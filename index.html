<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kleinanzeigen Deal Checker</title>
  <link rel="icon" type="image/png" href="https://cdn.reversed.dev/pictures/kleinanzeigen_icon.png">
  <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
  <link rel="manifest" href="https://shsf-api.reversed.dev/api/exec/7/c109a958-e326-4619-993f-44985da7cec7/manifest.json">
</head>

<body class="bg-gradient-to-br from-slate-900 via-slate-800 to-slate-900 min-h-screen flex flex-col items-center justify-start transition-colors duration-300 py-4 md:py-8">
  <div class="w-full max-w-6xl mx-4 rounded-xl shadow-2xl bg-gradient-to-br from-slate-800 via-slate-800 to-slate-700 border border-slate-600/50 backdrop-blur-sm">
    <div class="py-4 px-4 md:py-8 md:px-8 flex flex-col gap-4 md:gap-6">
      <div class="text-center">
        <div class="flex items-center justify-center gap-2 md:gap-4 mb-4">
          <a href="https://www.kleinanzeigen.de" target="_blank" class="hover:scale-105 transition-transform duration-200">
            <img src="https://static.kleinanzeigen.de/static/img/common/logo/logo-kleinanzeigen-horizontal.svg" alt="Kleinanzeigen" class="h-8 opacity-80 hover:opacity-100 transition-opacity">
          </a>
          <div class="w-px h-8 bg-slate-600"></div>
          <h1 class="text-2xl md:text-3xl font-semibold bg-gradient-to-r from-slate-100 via-rose-200 to-pink-200 bg-clip-text text-transparent tracking-tight">Deal Checker</h1>
        </div>
        <p class="text-slate-400 text-sm md:text-base">AI-powered deal analysis for smarter shopping decisions</p>
      </div>
      <form id="dealForm" class="flex flex-col gap-3 max-w-2xl mx-auto w-full">
        <input id="urlInput" autocomplete="off" autocorrect="off" autofocus aria-selected="true" type="text" placeholder="Paste text containing Kleinanzeigen link..."
          class="px-4 py-3 rounded-lg bg-slate-700/80 backdrop-blur-sm text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-rose-500 focus:bg-slate-700 transition-all duration-200 border border-slate-600 text-lg shadow-lg" />
        <button type="submit" id="checkBtn"
          class="bg-gradient-to-r from-rose-600 via-pink-600 to-rose-600 hover:from-rose-500 hover:via-pink-500 hover:to-rose-500 text-white font-medium py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-xl hover:shadow-rose-500/25 hover:scale-[1.02] transform">
          <svg class="w-5 h-5 animate-spin hidden" id="spinner" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
          </svg>
          <span id="btnText">Check Deal</span>
        </button>
      </form>
      
      <!-- Question Form (hidden by default) -->
      <form id="questionForm" class="hidden flex-col gap-3 max-w-2xl mx-auto w-full">
        <input id="questionInput" type="text" placeholder="Ask AI a question about this product..."
          class="px-4 py-3 rounded-lg bg-slate-700/80 backdrop-blur-sm text-slate-100 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:bg-slate-700 transition-all duration-200 border border-slate-600 text-lg shadow-lg" />
        <div class="flex gap-2">
          <button type="submit" id="askBtn"
            class="flex-1 bg-gradient-to-r from-blue-600 via-indigo-600 to-blue-600 hover:from-blue-500 hover:via-indigo-500 hover:to-blue-500 text-white font-medium py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-xl hover:shadow-blue-500/25 hover:scale-[1.02] transform">
            <svg class="w-5 h-5 animate-spin hidden" id="askSpinner" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
            </svg>
            <span id="askBtnText">Ask Question</span>
          </button>
          <button type="button" id="newCheckBtn"
            class="px-6 bg-gradient-to-r from-slate-600 to-slate-700 hover:from-slate-500 hover:to-slate-600 text-white font-medium py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2 shadow-lg hover:scale-[1.02] transform">
            New Check
          </button>
        </div>
      </form>

      <div id="result" class="mt-4"></div>
    </div>
  </div>
  <footer class="mt-4 md:mt-8 text-base text-slate-400 text-center">
    <span>Made with <span class="text-rose-400">♥</span> by <a href="https://space.reversed.dev/" target="_blank" rel="noopener noreferrer" class="underline hover:text-rose-300">Space</a></span>
  </footer>
  <script>
    const form = document.getElementById('dealForm');
    const questionForm = document.getElementById('questionForm');
    const urlInput = document.getElementById('urlInput');
    const questionInput = document.getElementById('questionInput');
    const resultDiv = document.getElementById('result');
    const checkBtn = document.getElementById('checkBtn');
    const askBtn = document.getElementById('askBtn');
    const newCheckBtn = document.getElementById('newCheckBtn');
    const spinner = document.getElementById('spinner');
    const askSpinner = document.getElementById('askSpinner');
    const btnText = document.getElementById('btnText');
    const askBtnText = document.getElementById('askBtnText');

    let currentUrl = '';

    function getActionColor(action) {
      switch (action) {
        case "buy": return "bg-emerald-600 text-white";
        case "negotiate": return "bg-purple-600 text-white";
        case "look_into": return "bg-amber-600 text-white";
        case "dont": return "bg-slate-600 text-white";
        case "dont_dont": return "bg-red-700 text-white";
        default: return "bg-slate-500 text-white";
      }
    }

    function getActionIcon(action) {
      switch (action) {
        case "buy": return "💰";
        case "negotiate": return "🤝";
        case "look_into": return "🔍";
        case "dont": return "❌";
        case "dont_dont": return "🚫";
        default: return "❓";
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function getDecisionGlow(action) {
      switch (action) {
        case "buy": return "glow-emerald";
        case "negotiate": return "glow-purple";
        case "look_into": return "glow-amber";
        case "dont": return "glow-slate";
        case "dont_dont": return "glow-red";
        default: return "glow-slate";
      }
    }

    function showQuestionForm() {
      form.classList.add('hidden');
      questionForm.classList.remove('hidden');
      questionForm.classList.add('flex');
      questionInput.focus();
    }

    function showDealForm() {
      questionForm.classList.add('hidden');
      questionForm.classList.remove('flex');
      form.classList.remove('hidden');
      urlInput.value = '';
      questionInput.value = '';
      resultDiv.innerHTML = '';
      currentUrl = '';
    }

    newCheckBtn.addEventListener('click', showDealForm);

    function sanitizeHtml(html) {
      // Create a temporary div to parse HTML
      const temp = document.createElement('div');
      temp.innerHTML = html;
      
      // Allow specific safe tags
      const allowedTags = ['p', 'br', 'strong', 'b', 'em', 'i', 'ul', 'ol', 'li', 'a', 'span'];
      const allowedAttributes = ['href', 'target', 'rel', 'style'];
      
      // Remove script tags and other dangerous elements
      const scripts = temp.querySelectorAll('script, object, embed, iframe, form, input');
      scripts.forEach(el => el.remove());
      
      // Remove dangerous attributes
      const allElements = temp.querySelectorAll('*');
      allElements.forEach(el => {
        // Remove if tag is not allowed
        if (!allowedTags.includes(el.tagName.toLowerCase())) {
          el.replaceWith(...el.childNodes);
          return;
        }
        
        // Remove dangerous attributes
        Array.from(el.attributes).forEach(attr => {
          if (!allowedAttributes.includes(attr.name.toLowerCase())) {
            el.removeAttribute(attr.name);
          }
        });
        
        // Sanitize href attributes
        if (el.hasAttribute('href')) {
          const href = el.getAttribute('href');
          if (!href.startsWith('http://') && !href.startsWith('https://')) {
            el.removeAttribute('href');
          } else {
            el.setAttribute('target', '_blank');
            el.setAttribute('rel', 'noopener noreferrer');
          }
        }
        
        // Sanitize style attributes (basic CSS only)
        if (el.hasAttribute('style')) {
          const style = el.getAttribute('style');
          // Only allow safe CSS properties
          const safeStyleRegex = /^(color|background-color|font-weight|font-style|text-decoration):\s*[a-zA-Z0-9#\s,().-]+;?\s*$/;
          if (!safeStyleRegex.test(style)) {
            el.removeAttribute('style');
          }
        }
      });
      
      return temp.innerHTML;
    }

    function renderAnnotations(annotations) {
      if (!annotations || Object.keys(annotations).length === 0) {
        return '';
      }

      const urlCitations = Object.values(annotations).filter(annotation => 
        annotation.type === 'url_citation' && annotation.url_citation
      );

      if (urlCitations.length === 0) {
        return '';
      }

      return `
        <div class="mt-4 pt-4 border-t border-slate-700/50">
          <h5 class="text-xs font-medium text-slate-400 mb-3 flex items-center gap-1">
            🔗 Sources
          </h5>
          <div class="space-y-2">
            ${urlCitations.map((annotation, index) => `
              <a href="${escapeHtml(annotation.url_citation.url)}" target="_blank" rel="noopener noreferrer" 
                 class="flex items-start gap-3 p-3 bg-slate-800/60 border border-slate-700/50 rounded-lg hover:bg-slate-800/80 transition-all duration-200 group hover:scale-[1.02]">
                <span class="flex-shrink-0 w-6 h-6 bg-blue-600/20 border border-blue-500/30 text-blue-300 rounded-full text-xs font-medium flex items-center justify-center mt-0.5">
                  ${index + 1}
                </span>
                <div class="flex-1 min-w-0">
                  <h6 class="text-sm font-medium text-slate-200 group-hover:text-blue-300 transition-colors line-clamp-2 mb-1">
                    ${escapeHtml(annotation.url_citation.title || 'Untitled')}
                  </h6>
                  <p class="text-xs text-slate-400 truncate">
                    ${escapeHtml(annotation.url_citation.url)}
                  </p>
                </div>
                <svg class="w-4 h-4 text-slate-400 group-hover:text-blue-300 transition-colors flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                </svg>
              </a>
            `).join('')}
          </div>
        </div>
      `;
    }

    questionForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const question = questionInput.value.trim();
      if (!question) {
        return;
      }

      askBtn.disabled = true;
      askSpinner.classList.remove('hidden');
      askBtnText.textContent = 'Asking...';

      try {
        const res = await fetch('https://shsf-api.reversed.dev/api/exec/7/c109a958-e326-4619-993f-44985da7cec7/item_question', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url: currentUrl, question })
        });
        const data = await res.json();
        
        if (data && data.answer) {
          const annotationsHtml = renderAnnotations(data.annotations);
          const sanitizedAnswer = sanitizeHtml(data.answer);
          
          resultDiv.innerHTML = `
            <div class="rounded-lg shadow-2xl border border-slate-700 bg-gradient-to-br from-slate-800 via-slate-800 to-slate-700 animate-fade-in">
              <div class="p-4 md:p-6">
                <div class="text-center mb-6">
                  <div class="text-4xl mb-4">🤖</div>
                  <h3 class="text-xl font-semibold bg-gradient-to-r from-slate-100 to-slate-300 bg-clip-text text-transparent mb-3">AI Answer</h3>
                </div>
                
                <div class="space-y-4">
                  <div class="bg-slate-900/60 border border-slate-700/50 rounded-lg p-4 backdrop-blur-sm">
                    <h4 class="text-sm font-medium text-slate-400 mb-2 flex items-center gap-1">
                      ❓ Your Question
                    </h4>
                    <p class="text-slate-200 leading-relaxed">${escapeHtml(question)}</p>
                  </div>
                  
                  <div class="bg-gradient-to-r from-blue-900/40 to-indigo-900/40 border border-blue-800/50 rounded-lg p-4 backdrop-blur-sm">
                    <h4 class="text-sm font-medium text-blue-300 mb-2 flex items-center gap-1">
                      💡 AI Response
                    </h4>
                    <div class="text-slate-200 leading-relaxed ai-response-content">${sanitizedAnswer}</div>
                    ${annotationsHtml}
                  </div>
                  
                  <div class="text-center pt-4">
                    <p class="text-slate-400 text-sm mb-4">Want to ask another question? Start a new check.</p>
                    <button onclick="showDealForm()" class="inline-flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-rose-600 to-pink-600 hover:from-rose-500 hover:to-pink-500 text-white font-medium rounded-lg transition-all duration-200 shadow-lg hover:scale-105">
                      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                      </svg>
                      New Check
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;
        } else if (data && data._res && data._res.error) {
          resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">${escapeHtml(data._res.error)}</div>`;
        } else {
          resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">Unexpected response format.</div>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">Error: ${escapeHtml(err.message)}</div>`;
      } finally {
        askBtn.disabled = false;
        askSpinner.classList.add('hidden');
        askBtnText.textContent = 'Ask Question';
      }
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      resultDiv.innerHTML = '';
      checkBtn.disabled = true;
      spinner.classList.remove('hidden');
      btnText.textContent = 'Checking...';

      const inputText = urlInput.value.trim();
      if (!inputText) {
        resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">Please enter some text containing a Kleinanzeigen link.</div>`;
        checkBtn.disabled = false;
        spinner.classList.add('hidden');
        btnText.textContent = 'Check Deal';
        return;
      }

      // Extract all URLs from the input text
      const urlRegex = /(https?:\/\/[^\s]+)/g;
      const extractedUrls = inputText.match(urlRegex) || [];

      // Filter for Kleinanzeigen URLs
      const kleinanzeigenUrls = extractedUrls.filter(url => url.includes('kleinanzeigen.de'));

      if (kleinanzeigenUrls.length === 0) {
        resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">No valid Kleinanzeigen link found. Please paste a link from Kleinanzeigen.</div>`;
        checkBtn.disabled = false;
        spinner.classList.add('hidden');
        btnText.textContent = 'Check Deal';
        return;
      } else if (kleinanzeigenUrls.length > 1) {
        resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">Multiple Kleinanzeigen links detected. Please provide only one.</div>`;
        checkBtn.disabled = false;
        spinner.classList.add('hidden');
        btnText.textContent = 'Check Deal';
        return;
      }

      const url = kleinanzeigenUrls[0];
      currentUrl = url;

      try {
        const res = await fetch('https://shsf-api.reversed.dev/api/exec/7/c109a958-e326-4619-993f-44985da7cec7/check_item', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url })
        });
        const data = await res.json();
        if (data && data.decision && data.item) {
          const decision = data.decision;
          const item = data.item;
          const actionColor = getActionColor(decision.action);
          const actionIcon = getActionIcon(decision.action);
          const glowClass = getDecisionGlow(decision.action);

          resultDiv.innerHTML = `
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 md:gap-6">
              <!-- Item Details Card -->
              <div class="rounded-lg shadow-2xl border border-slate-700 bg-gradient-to-br from-slate-800 via-slate-800 to-slate-700 animate-fade-in overflow-hidden hover:scale-[1.02] transition-all duration-300 ${glowClass}">
                <div class="p-4 md:p-6">
                  <div class="flex flex-col sm:flex-row items-center sm:items-start gap-4 mb-4 md:mb-6">
                    <div class="w-20 h-20 md:w-24 md:h-24 bg-slate-700 rounded-lg flex items-center justify-center overflow-hidden flex-shrink-0 shadow-inner">
                      ${item.image_url ? `<img src="${item.image_url}" alt="Item image" class="object-cover w-full h-full rounded-lg">` : `<div class="text-slate-500 text-2xl">🖼️</div>`}
                    </div>
                    <div class="flex-1 min-w-0 text-center sm:text-left">
                      <h2 class="text-lg md:text-xl font-semibold text-slate-100 mb-2 line-clamp-2">${escapeHtml(item.title || 'No title available')}</h2>
                      <div class="flex items-center justify-center sm:justify-start gap-2 mb-3">
                        <span class="bg-gradient-to-r from-rose-900/40 to-pink-900/40 border border-rose-800/50 text-rose-200 px-2 md:px-3 py-1 md:py-1.5 rounded-md font-semibold text-sm md:text-lg shadow-lg backdrop-blur-sm">
                          ${item.price ? escapeHtml(item.price) + ' ' + (item.currency || '') : 'Price not available'}
                        </span>
                      </div>
                      <a href="${url}" target="_blank" rel="noopener noreferrer" 
                         class="inline-flex items-center gap-2 px-2 md:px-3 py-1 md:py-1.5 bg-gradient-to-r from-blue-600/80 to-indigo-600/80 hover:from-blue-500/90 hover:to-indigo-500/90 text-white text-xs md:text-sm font-medium rounded-md transition-all duration-200 shadow-md backdrop-blur-sm hover:scale-105">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                        </svg>
                        View Original Listing
                      </a>
                    </div>
                  </div>

                  <!-- Location and Category -->
                  <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 md:gap-4 mb-4 md:mb-6">
                    <div>
                      <h3 class="text-sm font-medium text-slate-400 mb-2 flex items-center gap-1">
                        📍 Location
                      </h3>
                      <div class="flex flex-wrap gap-2">
                        ${item.locality || item.region ? `<span class="bg-gradient-to-r from-purple-900/40 to-indigo-900/40 border border-purple-800/50 text-purple-200 px-2.5 py-1 rounded-md text-sm shadow-md backdrop-blur-sm">${escapeHtml((item.locality || '') + ' ' + (item.region || ''))}</span>` : '<span class="text-slate-500 text-sm">Not specified</span>'}
                        ${item.country ? `<span class="bg-slate-700/60 border border-slate-600 text-slate-300 px-2.5 py-1 rounded-md text-sm shadow-md backdrop-blur-sm">${escapeHtml(item.country)}</span>` : ''}
                      </div>
                    </div>
                    <div>
                      <h3 class="text-sm font-medium text-slate-400 mb-2 flex items-center gap-1">
                        🏷️ Category
                      </h3>
                      ${item.category ? `<span class="bg-gradient-to-r from-pink-900/40 to-rose-900/40 border border-pink-800/50 text-pink-200 px-2.5 py-1 rounded-md text-sm shadow-md backdrop-blur-sm">${escapeHtml(item.category)}</span>` : '<span class="text-slate-500 text-sm">Not specified</span>'}
                    </div>
                  </div>

                  <!-- Features -->
                  <div class="mb-4 md:mb-6">
                    <h3 class="text-sm font-medium text-slate-400 mb-3 flex items-center gap-1">
                      ⚙️ Meta Data
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 text-sm">
                      <div class="flex items-center gap-2 p-3 rounded-lg bg-slate-900/60 border border-slate-700/50 backdrop-blur-sm hover:bg-slate-900/80 transition-colors">
                        <span>${item.price_negotiable ? '💬' : '🔒'}</span>
                        <span class="text-slate-300">${item.price_negotiable ? 'Negotiable price' : 'Fixed price'}</span>
                      </div>
                      <div class="flex items-center gap-2 p-3 rounded-lg bg-slate-900/60 border border-slate-700/50 backdrop-blur-sm hover:bg-slate-900/80 transition-colors">
                        <span>${item.shipping_available ? '📦' : '🚫'}</span>
                        <span class="text-slate-300">${item.shipping_available ? 'Shipping available' : 'Pickup only'}</span>
                      </div>
                      ${item.safe_pay_enabled ? '<div class="flex items-center gap-2 p-3 rounded-lg bg-emerald-900/40 border border-emerald-800/50 backdrop-blur-sm hover:bg-emerald-900/60 transition-colors"><span>✓</span><span class="text-emerald-300">Safe Pay enabled</span></div>' : ''}
                      ${item.shipping_info ? `<div class="flex items-center gap-2 p-3 rounded-lg bg-slate-900/60 border border-slate-700/50 backdrop-blur-sm hover:bg-slate-900/80 transition-colors col-span-full"><span>ℹ️</span><span class="text-slate-300">${escapeHtml(item.shipping_info)}</span></div>` : ''}
                    </div>
                  </div>

                  <!-- Description -->
                  ${item.description ? `
                    <div>
                      <h3 class="text-sm font-medium text-slate-400 mb-3 flex items-center gap-1">
                        📝 Description
                      </h3>
                      <div class="bg-slate-900/60 border border-slate-700/50 rounded-lg p-3 md:p-4 max-h-32 md:max-h-48 overflow-y-auto backdrop-blur-sm">
                        <p class="text-slate-300 text-sm whitespace-pre-wrap leading-relaxed">${escapeHtml(item.description)}</p>
                      </div>
                    </div>
                  ` : ''}
                </div>
              </div>

              <!-- AI Decision Card -->
              <div class="rounded-lg shadow-2xl border border-slate-700 bg-gradient-to-br from-slate-800 via-slate-800 to-slate-700 animate-fade-in hover:scale-[1.02] transition-all duration-300 ${glowClass}">
                <div class="p-4 md:p-6">
                  <div class="text-center mb-4 md:mb-6">
                    <div class="text-4xl md:text-5xl mb-4 animate-bounce">${actionIcon}</div>
                    <h3 class="text-lg md:text-xl font-semibold bg-gradient-to-r from-slate-100 to-slate-300 bg-clip-text text-transparent mb-3">AI Recommendation</h3>
                    <span class="px-3 md:px-4 py-1 md:py-2 rounded-lg text-xs md:text-sm font-medium uppercase ${actionColor} shadow-lg backdrop-blur-sm">${decision.action.replace('_', ' ')}</span>
                  </div>
                  
                  <!-- Confidence Meter -->
                  <div class="mb-4 md:mb-6">
                    <div class="flex items-center justify-between mb-3">
                      <span class="text-sm text-slate-400 flex items-center gap-1">
                        📊 Confidence Level
                      </span>
                      <span class="text-lg font-bold bg-gradient-to-r from-slate-200 to-slate-400 bg-clip-text text-transparent">${(decision.confidence * 100).toFixed(0)}%</span>
                    </div>
                    <div class="w-full bg-slate-700/60 rounded-full h-4 shadow-inner backdrop-blur-sm border border-slate-600">
                      <div class="bg-gradient-to-r from-rose-500 via-pink-500 to-rose-500 h-4 rounded-full transition-all duration-1000 ease-out shadow-lg" style="width: ${decision.confidence * 100}%"></div>
                    </div>
                    <div class="text-xs text-slate-500 mt-2 text-center">
                      ${decision.confidence >= 0.8 ? '🎯 High confidence - Strong recommendation' : decision.confidence >= 0.6 ? '⚖️ Medium confidence - Consider carefully' : '⚠️ Low confidence - Proceed with caution'}
                    </div>
                  </div>
                  
                  <!-- Analysis -->
                  <div class="bg-slate-900/60 border border-slate-700/50 rounded-lg p-3 md:p-4 mb-4 md:mb-6 backdrop-blur-sm">
                    <h4 class="text-sm font-medium text-slate-400 mb-3 flex items-center gap-1">
                      🤖 AI Analysis
                    </h4>
                    <p class="text-slate-200 leading-relaxed">${escapeHtml(decision.reason)}</p>
                  </div>

                  <!-- Action Details -->
                  <div class="space-y-2 md:space-y-3">
                    <div class="flex items-center justify-between p-3 bg-slate-900/40 rounded-lg backdrop-blur-sm border border-slate-700/30 hover:bg-slate-900/60 transition-colors">
                      <span class="text-slate-400 text-sm flex items-center gap-1">🎯 Recommended Action</span>
                      <span class="text-slate-200 font-medium capitalize">${decision.action.replace('_', ' ')}</span>
                    </div>
                    <div class="flex items-center justify-between p-3 bg-slate-900/40 rounded-lg backdrop-blur-sm border border-slate-700/30 hover:bg-slate-900/60 transition-colors">
                      <span class="text-slate-400 text-sm flex items-center gap-1">🎲 Decision Certainty</span>
                      <span class="text-slate-200 font-medium">${decision.confidence >= 0.8 ? 'High' : decision.confidence >= 0.6 ? 'Medium' : 'Low'}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
          
          // Show question form after successful analysis
          setTimeout(() => {
            showQuestionForm();
          }, 500);
        } else if (data && data._res && data._res.error) {
          resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">${escapeHtml(data._res.error)}</div>`;
        } else {
          resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">Unexpected response format.</div>`;
        }
      } catch (err) {
        resultDiv.innerHTML = `<div class="text-red-400 text-sm bg-red-900/20 border border-red-800/50 rounded-lg p-4 max-w-2xl mx-auto backdrop-blur-sm shadow-lg">Error: ${escapeHtml(err.message)}</div>`;
      } finally {
        checkBtn.disabled = false;
        spinner.classList.add('hidden');
        btnText.textContent = 'Check Deal';
      }
    });

    // Check for URL parameter and auto-submit
    function checkUrlParam() {
      const urlParams = new URLSearchParams(window.location.search);
      let urlParam = urlParams.get('url');
      const dontautostart = urlParams.get('dont_auto_start');
      
      if (urlParam ) {
        urlParam = urlParam.replaceAll("SLASH", "/");
        urlInput.value = urlParam;
        if (dontautostart === 'true') {
          return;
        }
        // Auto-submit the form after a short delay to ensure DOM is ready
        setTimeout(() => {
          form.dispatchEvent(new Event('submit'));
        }, 100);
      }
    }

    // Initialize URL parameter check when page loads
    document.addEventListener('DOMContentLoaded', checkUrlParam);
  </script>
  <style>
    @keyframes fade-in {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes bounce {
      0%, 20%, 53%, 80%, 100% {
        transform: translateY(0);
      }
      40%, 43% {
        transform: translateY(-10px);
      }
      70% {
        transform: translateY(-5px);
      }
      90% {
        transform: translateY(-2px);
      }
    }

    .animate-fade-in {
      animation: fade-in 0.5s ease;
    }

    .animate-bounce {
      animation: bounce 2s infinite;
    }

    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .line-clamp-3 {
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Decision-based glow effects */
    .glow-emerald {
      box-shadow: 0 0 20px rgba(16, 185, 129, 0.3), 0 0 40px rgba(16, 185, 129, 0.1);
    }

    .glow-purple {
      box-shadow: 0 0 20px rgba(147, 51, 234, 0.3), 0 0 40px rgba(147, 51, 234, 0.1);
    }

    .glow-amber {
      box-shadow: 0 0 20px rgba(245, 158, 11, 0.3), 0 0 40px rgba(245, 158, 11, 0.1);
    }

    .glow-slate {
      box-shadow: 0 0 20px rgba(100, 116, 139, 0.2), 0 0 40px rgba(100, 116, 139, 0.1);
    }

    .glow-red {
      box-shadow: 0 0 20px rgba(220, 38, 38, 0.3), 0 0 40px rgba(220, 38, 38, 0.1);
    }

    /* Custom scrollbar for dark theme */
    ::-webkit-scrollbar {
      width: 8px;
      background: #1e293b;
    }

    ::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #e11d48 0%, #be185d 100%);
      border-radius: 8px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #be123c 0%, #9d174d 100%);
    }

    /* AI Response Content Styling */
    .ai-response-content p {
      margin-bottom: 0.75rem;
    }

    .ai-response-content p:last-child {
      margin-bottom: 0;
    }

    .ai-response-content strong,
    .ai-response-content b {
      font-weight: 600;
      color: #f1f5f9;
    }

    .ai-response-content em,
    .ai-response-content i {
      font-style: italic;
      color: #cbd5e1;
    }

    .ai-response-content ul,
    .ai-response-content ol {
      margin: 0.75rem 0;
      padding-left: 1.5rem;
    }

    .ai-response-content ul {
      list-style-type: disc;
    }

    .ai-response-content ol {
      list-style-type: decimal;
    }

    .ai-response-content li {
      margin-bottom: 0.25rem;
      color: #e2e8f0;
    }

    .ai-response-content a {
      color: #60a5fa;
      text-decoration: underline;
      text-underline-offset: 2px;
      transition: color 0.2s ease;
    }

    .ai-response-content a:hover {
      color: #93c5fd;
    }

    .ai-response-content br {
      line-height: 1.5;
    }

    /* Custom spacing for better readability */
    .ai-response-content > *:first-child {
      margin-top: 0;
    }

    .ai-response-content > *:last-child {
      margin-bottom: 0;
    }
  </style>
</body>

</html>